<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 神经网络 | 现代精算统计模型</title>
  <meta name="description" content="The output format is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="2 神经网络 | 现代精算统计模型" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="The output format is bookdown::gitbook." />
  <meta name="github-repo" content="sxpyggy/Modern-Actuarial-Models" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 神经网络 | 现代精算统计模型" />
  
  <meta name="twitter:description" content="The output format is bookdown::gitbook." />
  

<meta name="author" content="Modern Actuarial Models" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch2.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">现代精算统计模型</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>👨‍🏫 欢迎</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#答疑"><i class="fa fa-check"></i>🤔 答疑</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#课程安排"><i class="fa fa-check"></i>🗓️ 课程安排</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ch00.html"><a href="ch00.html"><i class="fa fa-check"></i>简介</a></li>
<li class="chapter" data-level="" data-path="ch0.html"><a href="ch0.html"><i class="fa fa-check"></i>准备工作</a><ul>
<li class="chapter" data-level="0.1" data-path="ch0.html"><a href="ch0.html#常用链接"><i class="fa fa-check"></i><b>0.1</b> 常用链接</a></li>
<li class="chapter" data-level="0.2" data-path="ch0.html"><a href="ch0.html#克隆代码"><i class="fa fa-check"></i><b>0.2</b> 克隆代码</a></li>
<li class="chapter" data-level="0.3" data-path="ch0.html"><a href="ch0.html#r-interface-to-keras"><i class="fa fa-check"></i><b>0.3</b> R interface to Keras</a><ul>
<li class="chapter" data-level="0.3.1" data-path="ch0.html"><a href="ch0.html#r自动安装"><i class="fa fa-check"></i><b>0.3.1</b> R自动安装</a></li>
<li class="chapter" data-level="0.3.2" data-path="ch0.html"><a href="ch0.html#使用reticulate关联conda环境"><i class="fa fa-check"></i><b>0.3.2</b> 使用reticulate关联conda环境</a></li>
<li class="chapter" data-level="0.3.3" data-path="ch0.html"><a href="ch0.html#指定conda安装"><i class="fa fa-check"></i><b>0.3.3</b> 指定conda安装</a></li>
<li class="chapter" data-level="0.3.4" data-path="ch0.html"><a href="ch0.html#使用reticulate安装"><i class="fa fa-check"></i><b>0.3.4</b> 使用reticulate安装</a></li>
</ul></li>
<li class="chapter" data-level="0.4" data-path="ch0.html"><a href="ch0.html#r-interface-to-python"><i class="fa fa-check"></i><b>0.4</b> R interface to Python</a><ul>
<li class="chapter" data-level="0.4.1" data-path="ch0.html"><a href="ch0.html#reticulate-常见命令"><i class="fa fa-check"></i><b>0.4.1</b> reticulate 常见命令</a></li>
<li class="chapter" data-level="0.4.2" data-path="ch0.html"><a href="ch0.html#切换r关联的conda环境"><i class="fa fa-check"></i><b>0.4.2</b> 切换R关联的conda环境</a></li>
</ul></li>
<li class="chapter" data-level="0.5" data-path="ch0.html"><a href="ch0.html#python"><i class="fa fa-check"></i><b>0.5</b> Python</a><ul>
<li class="chapter" data-level="0.5.1" data-path="ch0.html"><a href="ch0.html#conda环境"><i class="fa fa-check"></i><b>0.5.1</b> Conda环境</a></li>
<li class="chapter" data-level="0.5.2" data-path="ch0.html"><a href="ch0.html#常用的conda命令"><i class="fa fa-check"></i><b>0.5.2</b> 常用的Conda命令</a></li>
<li class="chapter" data-level="0.5.3" data-path="ch0.html"><a href="ch0.html#tensorflowpytorch-gpu-version"><i class="fa fa-check"></i><b>0.5.3</b> Tensorflow/Pytorch GPU version</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1" data-path="ch2.html"><a href="ch2.html"><i class="fa fa-check"></i><b>1</b> 车险索赔频率预测</a><ul>
<li class="chapter" data-level="1.1" data-path="ch2.html"><a href="ch2.html#背景介绍"><i class="fa fa-check"></i><b>1.1</b> 背景介绍</a></li>
<li class="chapter" data-level="1.2" data-path="ch2.html"><a href="ch2.html#预测模型概述"><i class="fa fa-check"></i><b>1.2</b> 预测模型概述</a></li>
<li class="chapter" data-level="1.3" data-path="ch2.html"><a href="ch2.html#特征工程"><i class="fa fa-check"></i><b>1.3</b> 特征工程</a><ul>
<li class="chapter" data-level="1.3.1" data-path="ch2.html"><a href="ch2.html#截断"><i class="fa fa-check"></i><b>1.3.1</b> 截断</a></li>
<li class="chapter" data-level="1.3.2" data-path="ch2.html"><a href="ch2.html#离散化"><i class="fa fa-check"></i><b>1.3.2</b> 离散化</a></li>
<li class="chapter" data-level="1.3.3" data-path="ch2.html"><a href="ch2.html#设定基础水平"><i class="fa fa-check"></i><b>1.3.3</b> 设定基础水平</a></li>
<li class="chapter" data-level="1.3.4" data-path="ch2.html"><a href="ch2.html#协变量变形"><i class="fa fa-check"></i><b>1.3.4</b> 协变量变形</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="ch2.html"><a href="ch2.html#训练集-验证集-测试集"><i class="fa fa-check"></i><b>1.4</b> 训练集-验证集-测试集</a></li>
<li class="chapter" data-level="1.5" data-path="ch2.html"><a href="ch2.html#泊松偏差损失函数"><i class="fa fa-check"></i><b>1.5</b> 泊松偏差损失函数</a></li>
<li class="chapter" data-level="1.6" data-path="ch2.html"><a href="ch2.html#泊松回归模型"><i class="fa fa-check"></i><b>1.6</b> 泊松回归模型</a></li>
<li class="chapter" data-level="1.7" data-path="ch2.html"><a href="ch2.html#泊松可加模型"><i class="fa fa-check"></i><b>1.7</b> 泊松可加模型</a></li>
<li class="chapter" data-level="1.8" data-path="ch2.html"><a href="ch2.html#泊松回归树"><i class="fa fa-check"></i><b>1.8</b> 泊松回归树</a></li>
<li class="chapter" data-level="1.9" data-path="ch2.html"><a href="ch2.html#随机森林"><i class="fa fa-check"></i><b>1.9</b> 随机森林</a></li>
<li class="chapter" data-level="1.10" data-path="ch2.html"><a href="ch2.html#泊松提升树"><i class="fa fa-check"></i><b>1.10</b> 泊松提升树</a></li>
<li class="chapter" data-level="1.11" data-path="ch2.html"><a href="ch2.html#模型比较"><i class="fa fa-check"></i><b>1.11</b> 模型比较</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ch3.html"><a href="ch3.html"><i class="fa fa-check"></i><b>2</b> 神经网络</a><ul>
<li class="chapter" data-level="2.1" data-path="ch3.html"><a href="ch3.html#建立神经网络的一般步骤"><i class="fa fa-check"></i><b>2.1</b> 建立神经网络的一般步骤</a></li>
<li class="chapter" data-level="2.2" data-path="ch3.html"><a href="ch3.html#数据预处理"><i class="fa fa-check"></i><b>2.2</b> 数据预处理</a></li>
<li class="chapter" data-level="2.3" data-path="ch3.html"><a href="ch3.html#神经网络提升模型"><i class="fa fa-check"></i><b>2.3</b> 神经网络提升模型</a></li>
<li class="chapter" data-level="2.4" data-path="ch3.html"><a href="ch3.html#训练模型"><i class="fa fa-check"></i><b>2.4</b> 训练模型</a></li>
<li class="chapter" data-level="2.5" data-path="ch3.html"><a href="ch3.html#其它模型"><i class="fa fa-check"></i><b>2.5</b> 其它模型</a></li>
<li class="chapter" data-level="2.6" data-path="ch3.html"><a href="ch3.html#模型训练"><i class="fa fa-check"></i><b>2.6</b> 模型训练</a></li>
<li class="chapter" data-level="2.7" data-path="ch3.html"><a href="ch3.html#总结"><i class="fa fa-check"></i><b>2.7</b> 总结</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/sxpyggy/Modern-Actuarial-Models/tree/modern-actuarial-models" target="blank">GitHub 仓库</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">现代精算统计模型</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch3" class="section level1">
<h1><span class="header-section-number">2</span> 神经网络</h1>
<div id="建立神经网络的一般步骤" class="section level2">
<h2><span class="header-section-number">2.1</span> 建立神经网络的一般步骤</h2>
<ol style="list-style-type: decimal">
<li><p>明确研究目标和数据类型</p></li>
<li><p>数据预处理</p>
<ul>
<li><p>总结性统计描述</p></li>
<li><p>缺失值、异常值处理</p></li>
<li><p>标准化处理</p></li>
<li><p>训练-验证-测试</p></li>
</ul></li>
<li><p>选取合适的神经网络类型</p>
<ul>
<li><p>全连接神经网络</p></li>
<li><p>卷积神经网络</p></li>
<li><p>递归神经网络</p></li>
</ul></li>
<li><p>建立神经网络</p>
<ul>
<li><p>全连接神经网络：隐藏层个数，每一层的神经元个数，激活函数，正则化手段，损失函数</p></li>
<li><p>卷积神经网络：卷积核大小，特征个数</p></li>
<li><p>递归神经网络：time step</p></li>
</ul></li>
<li><p>训练神经网络</p>
<ul>
<li><p>patience</p></li>
<li><p>epoch</p></li>
<li><p>batch size</p></li>
<li><p>optimizer</p></li>
</ul></li>
<li><p>返回第4步调整模型的结构参数（hyper-parameter tuning），观察验证损失的变化，选取最终模型。</p></li>
</ol>
</div>
<div id="数据预处理" class="section level2">
<h2><span class="header-section-number">2.2</span> 数据预处理</h2>
<ul>
<li><p>连续型变量：标准化处理</p></li>
<li><p>分类变量：one-hot encoding 或者 embedding layer</p></li>
<li><p>训练集-验证集-测试集：分层抽样</p></li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="ch3.html#cb22-1"></a>PreProcess.Continuous &lt;-<span class="st"> </span><span class="cf">function</span>(var1, dat1){</span>
<span id="cb22-2"><a href="ch3.html#cb22-2"></a>   <span class="kw">names</span>(dat1)[<span class="kw">names</span>(dat1) <span class="op">==</span><span class="st"> </span>var1]  &lt;-<span class="st"> &quot;V1&quot;</span></span>
<span id="cb22-3"><a href="ch3.html#cb22-3"></a>   dat1<span class="op">$</span>X &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(dat1<span class="op">$</span>V1)</span>
<span id="cb22-4"><a href="ch3.html#cb22-4"></a>   dat1<span class="op">$</span>X &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">*</span>(dat1<span class="op">$</span>X<span class="op">-</span><span class="kw">min</span>(dat1<span class="op">$</span>X))<span class="op">/</span>(<span class="kw">max</span>(dat1<span class="op">$</span>X)<span class="op">-</span><span class="kw">min</span>(dat1<span class="op">$</span>X))<span class="op">-</span><span class="dv">1</span></span>
<span id="cb22-5"><a href="ch3.html#cb22-5"></a>   <span class="kw">names</span>(dat1)[<span class="kw">names</span>(dat1) <span class="op">==</span><span class="st"> &quot;V1&quot;</span>]  &lt;-<span class="st"> </span>var1</span>
<span id="cb22-6"><a href="ch3.html#cb22-6"></a>   <span class="kw">names</span>(dat1)[<span class="kw">names</span>(dat1) <span class="op">==</span><span class="st"> &quot;X&quot;</span>]  &lt;-<span class="st"> </span><span class="kw">paste</span>(var1,<span class="st">&quot;X&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb22-7"><a href="ch3.html#cb22-7"></a>   dat1</span>
<span id="cb22-8"><a href="ch3.html#cb22-8"></a>   }</span>
<span id="cb22-9"><a href="ch3.html#cb22-9"></a></span>
<span id="cb22-10"><a href="ch3.html#cb22-10"></a>Features.PreProcess &lt;-<span class="st"> </span><span class="cf">function</span>(dat1){</span>
<span id="cb22-11"><a href="ch3.html#cb22-11"></a>   dat1<span class="op">$</span>VehPower &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>VehPower,<span class="dv">9</span>)</span>
<span id="cb22-12"><a href="ch3.html#cb22-12"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;VehPower&quot;</span>, dat1)   </span>
<span id="cb22-13"><a href="ch3.html#cb22-13"></a>   dat1<span class="op">$</span>VehAge &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>VehAge,<span class="dv">20</span>)</span>
<span id="cb22-14"><a href="ch3.html#cb22-14"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;VehAge&quot;</span>, dat1)   </span>
<span id="cb22-15"><a href="ch3.html#cb22-15"></a>   dat1<span class="op">$</span>DrivAge &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>DrivAge,<span class="dv">90</span>)</span>
<span id="cb22-16"><a href="ch3.html#cb22-16"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;DrivAge&quot;</span>, dat1)   </span>
<span id="cb22-17"><a href="ch3.html#cb22-17"></a>   dat1<span class="op">$</span>BonusMalus &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>BonusMalus,<span class="dv">150</span>)</span>
<span id="cb22-18"><a href="ch3.html#cb22-18"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;BonusMalus&quot;</span>, dat1)   </span>
<span id="cb22-19"><a href="ch3.html#cb22-19"></a>   dat1<span class="op">$</span>VehBrandX &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>VehBrand)<span class="op">-</span><span class="dv">1</span>  <span class="co"># categorical variable</span></span>
<span id="cb22-20"><a href="ch3.html#cb22-20"></a>   dat1<span class="op">$</span>VehGas &lt;-<span class="st"> </span><span class="kw">as.factor</span>(dat1<span class="op">$</span>VehGas)</span>
<span id="cb22-21"><a href="ch3.html#cb22-21"></a>   dat1<span class="op">$</span>VehGasX &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>VehGas) <span class="op">-</span><span class="st"> </span><span class="fl">1.5</span> <span class="co"># binary: continuous or categorical</span></span>
<span id="cb22-22"><a href="ch3.html#cb22-22"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;Area&quot;</span>, dat1)   </span>
<span id="cb22-23"><a href="ch3.html#cb22-23"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;Density&quot;</span>, dat1)   </span>
<span id="cb22-24"><a href="ch3.html#cb22-24"></a>   dat1<span class="op">$</span>RegionX &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>Region) <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="co"># categorical</span></span>
<span id="cb22-25"><a href="ch3.html#cb22-25"></a>   dat1</span>
<span id="cb22-26"><a href="ch3.html#cb22-26"></a>}</span>
<span id="cb22-27"><a href="ch3.html#cb22-27"></a></span>
<span id="cb22-28"><a href="ch3.html#cb22-28"></a>dat2 &lt;-<span class="st"> </span><span class="kw">Features.PreProcess</span>(freMTPL2freq)   </span>
<span id="cb22-29"><a href="ch3.html#cb22-29"></a><span class="kw">names</span>(dat2)</span>
<span id="cb22-30"><a href="ch3.html#cb22-30"></a>dat2_train&lt;-dat2[index_train,]</span>
<span id="cb22-31"><a href="ch3.html#cb22-31"></a>dat2_valid&lt;-dat2[index_valid,]</span>
<span id="cb22-32"><a href="ch3.html#cb22-32"></a>dat2_test&lt;-dat2[index_test,]</span>
<span id="cb22-33"><a href="ch3.html#cb22-33"></a>dat2_learn&lt;-dat2[index_learn,]</span></code></pre></div>
</div>
<div id="神经网络提升模型" class="section level2">
<h2><span class="header-section-number">2.3</span> 神经网络提升模型</h2>
<p>基本结构</p>
<p><span class="math display">\[\ln \lambda(\mathbf{x})= e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\hat{\lambda}^{\text{NN}}(\mathbf{x})\]</span></p>
<p>其中，<span class="math inline">\(\hat{\lambda}^{\text{GAM}}\)</span>为广义线性模型的索赔频率估计值， <span class="math inline">\(\hat{\lambda}^{\text{NN}}\)</span>为神经网络索赔频率的估计值。使用上述模型的优点：</p>
<ul>
<li><p>部分可解释性</p></li>
<li><p>神经网络容易训练</p></li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="ch3.html#cb23-1"></a>lambda.hom &lt;-<span class="st"> </span><span class="kw">sum</span>(dat2_train<span class="op">$</span>ClaimNb)<span class="op">/</span><span class="kw">sum</span>(dat2_train<span class="op">$</span>Exposure);lambda.hom</span>
<span id="cb23-2"><a href="ch3.html#cb23-2"></a><span class="kw">names</span>(dat2)</span>
<span id="cb23-3"><a href="ch3.html#cb23-3"></a></span>
<span id="cb23-4"><a href="ch3.html#cb23-4"></a><span class="co"># index of continous variables (non-categorical)</span></span>
<span id="cb23-5"><a href="ch3.html#cb23-5"></a></span>
<span id="cb23-6"><a href="ch3.html#cb23-6"></a>features &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">13</span><span class="op">:</span><span class="dv">16</span>, <span class="dv">18</span><span class="op">:</span><span class="dv">20</span>)</span>
<span id="cb23-7"><a href="ch3.html#cb23-7"></a><span class="kw">names</span>(dat2_learn)[features]</span>
<span id="cb23-8"><a href="ch3.html#cb23-8"></a>(q0 &lt;-<span class="st"> </span><span class="kw">length</span>(features))</span>
<span id="cb23-9"><a href="ch3.html#cb23-9"></a></span>
<span id="cb23-10"><a href="ch3.html#cb23-10"></a><span class="co"># training data</span></span>
<span id="cb23-11"><a href="ch3.html#cb23-11"></a></span>
<span id="cb23-12"><a href="ch3.html#cb23-12"></a>Xtrain&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train[, features])  <span class="co"># design matrix learning sample</span></span>
<span id="cb23-13"><a href="ch3.html#cb23-13"></a>Brtrain &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>VehBrandX)</span>
<span id="cb23-14"><a href="ch3.html#cb23-14"></a>Retrain &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>RegionX)</span>
<span id="cb23-15"><a href="ch3.html#cb23-15"></a>Ytrain&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>ClaimNb)</span>
<span id="cb23-16"><a href="ch3.html#cb23-16"></a>Vtrain&lt;-<span class="kw">as.matrix</span>(<span class="kw">log</span>(dat2_train<span class="op">$</span>Exposure<span class="op">*</span>lambda.hom))</span>
<span id="cb23-17"><a href="ch3.html#cb23-17"></a></span>
<span id="cb23-18"><a href="ch3.html#cb23-18"></a><span class="co"># validation data </span></span>
<span id="cb23-19"><a href="ch3.html#cb23-19"></a></span>
<span id="cb23-20"><a href="ch3.html#cb23-20"></a>Xvalid&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid[, features])  <span class="co"># design matrix learning sample</span></span>
<span id="cb23-21"><a href="ch3.html#cb23-21"></a>Brvalid &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid<span class="op">$</span>VehBrandX)</span>
<span id="cb23-22"><a href="ch3.html#cb23-22"></a>Revalid &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid<span class="op">$</span>RegionX)</span>
<span id="cb23-23"><a href="ch3.html#cb23-23"></a>Yvalid&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid<span class="op">$</span>ClaimNb)</span>
<span id="cb23-24"><a href="ch3.html#cb23-24"></a>Vvalid&lt;-<span class="kw">as.matrix</span>(<span class="kw">log</span>(dat2_valid<span class="op">$</span>Exposure<span class="op">*</span>lambda.hom))</span>
<span id="cb23-25"><a href="ch3.html#cb23-25"></a>xxvalid&lt;-<span class="kw">list</span>(Xvalid,Brvalid,Revalid,Vvalid)</span>
<span id="cb23-26"><a href="ch3.html#cb23-26"></a></span>
<span id="cb23-27"><a href="ch3.html#cb23-27"></a><span class="co"># testing data</span></span>
<span id="cb23-28"><a href="ch3.html#cb23-28"></a></span>
<span id="cb23-29"><a href="ch3.html#cb23-29"></a>Xtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test[, features])    <span class="co"># design matrix test sample</span></span>
<span id="cb23-30"><a href="ch3.html#cb23-30"></a>Brtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test<span class="op">$</span>VehBrandX)</span>
<span id="cb23-31"><a href="ch3.html#cb23-31"></a>Retest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test<span class="op">$</span>RegionX)</span>
<span id="cb23-32"><a href="ch3.html#cb23-32"></a>Ytest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test<span class="op">$</span>ClaimNb)</span>
<span id="cb23-33"><a href="ch3.html#cb23-33"></a>Vtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat2_test<span class="op">$</span>Exposure<span class="op">*</span>lambda.hom))</span>
<span id="cb23-34"><a href="ch3.html#cb23-34"></a></span>
<span id="cb23-35"><a href="ch3.html#cb23-35"></a>CANN &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># 0 = normal NN, 1=CANN</span></span>
<span id="cb23-36"><a href="ch3.html#cb23-36"></a><span class="cf">if</span> (CANN<span class="op">==</span><span class="dv">1</span>){</span>
<span id="cb23-37"><a href="ch3.html#cb23-37"></a>     Vtrain &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_train<span class="op">$</span>fitGAM1))</span>
<span id="cb23-38"><a href="ch3.html#cb23-38"></a>     Vvalid&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_valid<span class="op">$</span>fitGAM1))</span>
<span id="cb23-39"><a href="ch3.html#cb23-39"></a>     Vtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_test<span class="op">$</span>fitGAM1))</span>
<span id="cb23-40"><a href="ch3.html#cb23-40"></a>}</span>
<span id="cb23-41"><a href="ch3.html#cb23-41"></a></span>
<span id="cb23-42"><a href="ch3.html#cb23-42"></a><span class="co"># hyperparameters of the neural network architecture</span></span>
<span id="cb23-43"><a href="ch3.html#cb23-43"></a></span>
<span id="cb23-44"><a href="ch3.html#cb23-44"></a>(BrLabel &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(dat2_train<span class="op">$</span>VehBrandX)))</span>
<span id="cb23-45"><a href="ch3.html#cb23-45"></a>(ReLabel &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(dat2_train<span class="op">$</span>RegionX)))</span>
<span id="cb23-46"><a href="ch3.html#cb23-46"></a>q1 &lt;-<span class="st"> </span><span class="dv">20</span>   </span>
<span id="cb23-47"><a href="ch3.html#cb23-47"></a>q2 &lt;-<span class="st"> </span><span class="dv">15</span></span>
<span id="cb23-48"><a href="ch3.html#cb23-48"></a>q3 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb23-49"><a href="ch3.html#cb23-49"></a>q4 &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb23-50"><a href="ch3.html#cb23-50"></a>d &lt;-<span class="st"> </span><span class="dv">1</span>        <span class="co"># dimensions embedding layers for categorical features</span></span>
<span id="cb23-51"><a href="ch3.html#cb23-51"></a></span>
<span id="cb23-52"><a href="ch3.html#cb23-52"></a><span class="co"># input layer</span></span>
<span id="cb23-53"><a href="ch3.html#cb23-53"></a></span>
<span id="cb23-54"><a href="ch3.html#cb23-54"></a>(Design   &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(q0),  <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;Design&#39;</span>))</span>
<span id="cb23-55"><a href="ch3.html#cb23-55"></a>(VehBrand &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>),   <span class="dt">dtype =</span> <span class="st">&#39;int32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;VehBrand&#39;</span>))</span>
<span id="cb23-56"><a href="ch3.html#cb23-56"></a>(Region   &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>),   <span class="dt">dtype =</span> <span class="st">&#39;int32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;Region&#39;</span>))</span>
<span id="cb23-57"><a href="ch3.html#cb23-57"></a>(LogVol   &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>),   <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;LogVol&#39;</span>))</span>
<span id="cb23-58"><a href="ch3.html#cb23-58"></a></span>
<span id="cb23-59"><a href="ch3.html#cb23-59"></a><span class="co"># embedding layer</span></span>
<span id="cb23-60"><a href="ch3.html#cb23-60"></a></span>
<span id="cb23-61"><a href="ch3.html#cb23-61"></a>(<span class="dt">BrandEmb =</span> VehBrand <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-62"><a href="ch3.html#cb23-62"></a><span class="st">      </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> BrLabel, <span class="dt">output_dim =</span> d, <span class="dt">input_length =</span> <span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&#39;BrandEmb&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-63"><a href="ch3.html#cb23-63"></a><span class="st">      </span><span class="kw">layer_flatten</span>(<span class="dt">name=</span><span class="st">&#39;Brand_flat&#39;</span>))</span>
<span id="cb23-64"><a href="ch3.html#cb23-64"></a><span class="co"># input_dim is the size of vocabulary; input_length is the length of input sequences</span></span>
<span id="cb23-65"><a href="ch3.html#cb23-65"></a>    </span>
<span id="cb23-66"><a href="ch3.html#cb23-66"></a>(<span class="dt">RegionEmb =</span> Region <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-67"><a href="ch3.html#cb23-67"></a><span class="st">      </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> ReLabel, <span class="dt">output_dim =</span> d, <span class="dt">input_length =</span> <span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&#39;RegionEmb&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-68"><a href="ch3.html#cb23-68"></a><span class="st">      </span><span class="kw">layer_flatten</span>(<span class="dt">name=</span><span class="st">&#39;Region_flat&#39;</span>))</span>
<span id="cb23-69"><a href="ch3.html#cb23-69"></a></span>
<span id="cb23-70"><a href="ch3.html#cb23-70"></a>Network =<span class="st"> </span><span class="kw">list</span>(Design, BrandEmb, RegionEmb) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_concatenate</span>(<span class="dt">name=</span><span class="st">&#39;concate&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-71"><a href="ch3.html#cb23-71"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q1, <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden1&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-72"><a href="ch3.html#cb23-72"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb23-73"><a href="ch3.html#cb23-73"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-74"><a href="ch3.html#cb23-74"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q2, <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden2&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-75"><a href="ch3.html#cb23-75"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb23-76"><a href="ch3.html#cb23-76"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-77"><a href="ch3.html#cb23-77"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q3, <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden3&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-78"><a href="ch3.html#cb23-78"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb23-79"><a href="ch3.html#cb23-79"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-80"><a href="ch3.html#cb23-80"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q4, <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden4&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-81"><a href="ch3.html#cb23-81"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb23-82"><a href="ch3.html#cb23-82"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb23-83"><a href="ch3.html#cb23-83"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">name=</span><span class="st">&#39;Network&#39;</span>,</span>
<span id="cb23-84"><a href="ch3.html#cb23-84"></a>                      <span class="dt">weights =</span> <span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(q4,<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb23-85"><a href="ch3.html#cb23-85"></a></span>
<span id="cb23-86"><a href="ch3.html#cb23-86"></a>Response =<span class="st"> </span><span class="kw">list</span>(Network, LogVol) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_add</span>(<span class="dt">name=</span><span class="st">&#39;Add&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-87"><a href="ch3.html#cb23-87"></a><span class="st">           </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span>k_exp, <span class="dt">name =</span> <span class="st">&#39;Response&#39;</span>, <span class="dt">trainable=</span><span class="ot">FALSE</span>,</span>
<span id="cb23-88"><a href="ch3.html#cb23-88"></a>                        <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">1</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb23-89"><a href="ch3.html#cb23-89"></a></span>
<span id="cb23-90"><a href="ch3.html#cb23-90"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> <span class="kw">c</span>(Design, VehBrand, Region, LogVol), <span class="dt">outputs =</span> <span class="kw">c</span>(Response))</span>
<span id="cb23-91"><a href="ch3.html#cb23-91"></a>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;poisson&#39;</span>)</span>
<span id="cb23-92"><a href="ch3.html#cb23-92"></a></span>
<span id="cb23-93"><a href="ch3.html#cb23-93"></a><span class="kw">compile</span>(model,<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;poisson&#39;</span>)</span>
<span id="cb23-94"><a href="ch3.html#cb23-94"></a><span class="kw">summary</span>(model)</span></code></pre></div>
</div>
<div id="训练模型" class="section level2">
<h2><span class="header-section-number">2.4</span> 训练模型</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="ch3.html#cb24-1"></a><span class="co"># fitting the neural network</span></span>
<span id="cb24-2"><a href="ch3.html#cb24-2"></a>early_stop &lt;-<span class="st"> </span><span class="kw">callback_early_stopping</span>(<span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">patience =</span><span class="dv">10</span>)</span>
<span id="cb24-3"><a href="ch3.html#cb24-3"></a>print_dot_callback &lt;-<span class="st"> </span><span class="kw">callback_lambda</span>(</span>
<span id="cb24-4"><a href="ch3.html#cb24-4"></a>  <span class="dt">on_epoch_end =</span> <span class="cf">function</span>(epoch, logs) {</span>
<span id="cb24-5"><a href="ch3.html#cb24-5"></a>    <span class="cf">if</span> (epoch <span class="op">%%</span><span class="st"> </span><span class="dv">50</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb24-6"><a href="ch3.html#cb24-6"></a>    <span class="kw">cat</span>(<span class="st">&quot;.&quot;</span>)</span>
<span id="cb24-7"><a href="ch3.html#cb24-7"></a>  }</span>
<span id="cb24-8"><a href="ch3.html#cb24-8"></a>)  </span>
<span id="cb24-9"><a href="ch3.html#cb24-9"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>();</span>
<span id="cb24-10"><a href="ch3.html#cb24-10"></a>fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="kw">list</span>(Xtrain, Brtrain, Retrain, Vtrain), Ytrain,</span>
<span id="cb24-11"><a href="ch3.html#cb24-11"></a>                     <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">batch_size=</span><span class="dv">5000</span>, <span class="dt">verbose=</span><span class="dv">1</span>,</span>
<span id="cb24-12"><a href="ch3.html#cb24-12"></a>                     <span class="dt">validation_data=</span><span class="kw">list</span>(xxvalid,Yvalid),</span>
<span id="cb24-13"><a href="ch3.html#cb24-13"></a>                     <span class="dt">callbacks=</span><span class="kw">list</span>(print_dot_callback,early_stop));</span>
<span id="cb24-14"><a href="ch3.html#cb24-14"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb24-15"><a href="ch3.html#cb24-15"></a></span>
<span id="cb24-16"><a href="ch3.html#cb24-16"></a><span class="kw">matplot</span>(<span class="kw">cbind</span>(fit<span class="op">$</span>metrics<span class="op">$</span>loss,fit<span class="op">$</span>metrics<span class="op">$</span>val_loss), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>)</span>
<span id="cb24-17"><a href="ch3.html#cb24-17"></a>fit<span class="op">$</span>metrics</span>
<span id="cb24-18"><a href="ch3.html#cb24-18"></a></span>
<span id="cb24-19"><a href="ch3.html#cb24-19"></a><span class="co"># calculating the predictions</span></span>
<span id="cb24-20"><a href="ch3.html#cb24-20"></a>dat2_test<span class="op">$</span>fitNN &lt;-<span class="st"> </span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">list</span>(Xtest, Brtest, Retest, Vtest)))</span>
<span id="cb24-21"><a href="ch3.html#cb24-21"></a><span class="kw">keras_poisson_dev</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb)</span>
<span id="cb24-22"><a href="ch3.html#cb24-22"></a><span class="kw">Poisson.Deviance</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb)</span></code></pre></div>
</div>
<div id="其它模型" class="section level2">
<h2><span class="header-section-number">2.5</span> 其它模型</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="ch3.html#cb25-1"></a>train.x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.matrix</span>(dat2_train[,<span class="kw">c</span>(<span class="st">&quot;VehPowerX&quot;</span>, <span class="st">&quot;VehAgeX&quot;</span>, <span class="st">&quot;VehGasX&quot;</span>)]),</span>
<span id="cb25-2"><a href="ch3.html#cb25-2"></a>                <span class="kw">as.matrix</span>(dat2_train[,<span class="st">&quot;VehBrandX&quot;</span>]),</span>
<span id="cb25-3"><a href="ch3.html#cb25-3"></a>                <span class="kw">as.matrix</span>(dat2_train[,<span class="kw">c</span>(<span class="st">&quot;DrivAgeX&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>)]),</span>
<span id="cb25-4"><a href="ch3.html#cb25-4"></a>                <span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_train<span class="op">$</span>fitGAM1)) )</span>
<span id="cb25-5"><a href="ch3.html#cb25-5"></a>valid.x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.matrix</span>(dat2_valid[,<span class="kw">c</span>(<span class="st">&quot;VehPowerX&quot;</span>, <span class="st">&quot;VehAgeX&quot;</span>, <span class="st">&quot;VehGasX&quot;</span>)]),</span>
<span id="cb25-6"><a href="ch3.html#cb25-6"></a>                <span class="kw">as.matrix</span>(dat2_valid[,<span class="st">&quot;VehBrandX&quot;</span>]),</span>
<span id="cb25-7"><a href="ch3.html#cb25-7"></a>                <span class="kw">as.matrix</span>(dat2_valid[,<span class="kw">c</span>(<span class="st">&quot;DrivAgeX&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>)]),</span>
<span id="cb25-8"><a href="ch3.html#cb25-8"></a>                <span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_valid<span class="op">$</span>fitGAM1)) )</span>
<span id="cb25-9"><a href="ch3.html#cb25-9"></a>test.x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.matrix</span>(dat2_test[,<span class="kw">c</span>(<span class="st">&quot;VehPowerX&quot;</span>, <span class="st">&quot;VehAgeX&quot;</span>, <span class="st">&quot;VehGasX&quot;</span>)]),</span>
<span id="cb25-10"><a href="ch3.html#cb25-10"></a>                <span class="kw">as.matrix</span>(dat2_test[,<span class="st">&quot;VehBrandX&quot;</span>]),</span>
<span id="cb25-11"><a href="ch3.html#cb25-11"></a>                <span class="kw">as.matrix</span>(dat2_test[,<span class="kw">c</span>(<span class="st">&quot;DrivAgeX&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>)]),</span>
<span id="cb25-12"><a href="ch3.html#cb25-12"></a>                <span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_test<span class="op">$</span>fitGAM1)) )</span>
<span id="cb25-13"><a href="ch3.html#cb25-13"></a></span>
<span id="cb25-14"><a href="ch3.html#cb25-14"></a>neurons &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">15</span>,<span class="dv">10</span>,<span class="dv">5</span>)</span>
<span id="cb25-15"><a href="ch3.html#cb25-15"></a></span>
<span id="cb25-16"><a href="ch3.html#cb25-16"></a>model<span class="fl">.2</span>IA &lt;-<span class="st"> </span><span class="cf">function</span>(Brlabel){</span>
<span id="cb25-17"><a href="ch3.html#cb25-17"></a>   Cont1        &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">3</span>), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name=</span><span class="st">&#39;Cont1&#39;</span>)</span>
<span id="cb25-18"><a href="ch3.html#cb25-18"></a>   Cat1         &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dtype =</span> <span class="st">&#39;int32&#39;</span>,   <span class="dt">name=</span><span class="st">&#39;Cat1&#39;</span>)</span>
<span id="cb25-19"><a href="ch3.html#cb25-19"></a>   Cont2        &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">2</span>), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name=</span><span class="st">&#39;Cont2&#39;</span>)</span>
<span id="cb25-20"><a href="ch3.html#cb25-20"></a>   LogExposure  &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;LogExposure&#39;</span>) </span>
<span id="cb25-21"><a href="ch3.html#cb25-21"></a>   </span>
<span id="cb25-22"><a href="ch3.html#cb25-22"></a>   x.input &lt;-<span class="st"> </span><span class="kw">c</span>(Cont1, Cat1, Cont2, LogExposure)</span>
<span id="cb25-23"><a href="ch3.html#cb25-23"></a>   <span class="co">#</span></span>
<span id="cb25-24"><a href="ch3.html#cb25-24"></a>   Cat1_embed =<span class="st"> </span>Cat1 <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb25-25"><a href="ch3.html#cb25-25"></a><span class="st">            </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> Brlabel, <span class="dt">output_dim =</span> <span class="dv">1</span>, <span class="dt">trainable=</span><span class="ot">TRUE</span>, </span>
<span id="cb25-26"><a href="ch3.html#cb25-26"></a>                    <span class="dt">input_length =</span> <span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&#39;Cat1_embed&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-27"><a href="ch3.html#cb25-27"></a><span class="st">                    </span><span class="kw">layer_flatten</span>(<span class="dt">name=</span><span class="st">&#39;Cat1_flat&#39;</span>)</span>
<span id="cb25-28"><a href="ch3.html#cb25-28"></a>   <span class="co">#</span></span>
<span id="cb25-29"><a href="ch3.html#cb25-29"></a>   NNetwork1 =<span class="st"> </span><span class="kw">list</span>(Cont1, Cat1_embed) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_concatenate</span>(<span class="dt">name=</span><span class="st">&#39;cont&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-30"><a href="ch3.html#cb25-30"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">1</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden1&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-31"><a href="ch3.html#cb25-31"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">2</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden2&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-32"><a href="ch3.html#cb25-32"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">3</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden3&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-33"><a href="ch3.html#cb25-33"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">name=</span><span class="st">&#39;NNetwork1&#39;</span>, </span>
<span id="cb25-34"><a href="ch3.html#cb25-34"></a>                    <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(neurons[<span class="dv">3</span>],<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb25-35"><a href="ch3.html#cb25-35"></a>   <span class="co">#</span></span>
<span id="cb25-36"><a href="ch3.html#cb25-36"></a>   NNetwork2 =<span class="st"> </span>Cont2 <span class="op">%&gt;%</span></span>
<span id="cb25-37"><a href="ch3.html#cb25-37"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">1</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden4&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-38"><a href="ch3.html#cb25-38"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">2</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden5&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-39"><a href="ch3.html#cb25-39"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">3</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden6&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-40"><a href="ch3.html#cb25-40"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">name=</span><span class="st">&#39;NNetwork2&#39;</span>, </span>
<span id="cb25-41"><a href="ch3.html#cb25-41"></a>                    <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(neurons[<span class="dv">3</span>],<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb25-42"><a href="ch3.html#cb25-42"></a></span>
<span id="cb25-43"><a href="ch3.html#cb25-43"></a>   <span class="co">#</span></span>
<span id="cb25-44"><a href="ch3.html#cb25-44"></a>   NNoutput =<span class="st"> </span><span class="kw">list</span>(NNetwork1, NNetwork2, LogExposure) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_add</span>(<span class="dt">name=</span><span class="st">&#39;Add&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-45"><a href="ch3.html#cb25-45"></a><span class="st">                 </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span>k_exp, <span class="dt">name =</span> <span class="st">&#39;NNoutput&#39;</span>, <span class="dt">trainable=</span><span class="ot">FALSE</span>,</span>
<span id="cb25-46"><a href="ch3.html#cb25-46"></a>                       <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb25-47"><a href="ch3.html#cb25-47"></a></span>
<span id="cb25-48"><a href="ch3.html#cb25-48"></a>   model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> x.input, <span class="dt">outputs =</span> <span class="kw">c</span>(NNoutput))</span>
<span id="cb25-49"><a href="ch3.html#cb25-49"></a>   model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;poisson&#39;</span>)        </span>
<span id="cb25-50"><a href="ch3.html#cb25-50"></a>   model</span>
<span id="cb25-51"><a href="ch3.html#cb25-51"></a>   }</span>
<span id="cb25-52"><a href="ch3.html#cb25-52"></a></span>
<span id="cb25-53"><a href="ch3.html#cb25-53"></a>model &lt;-<span class="st"> </span><span class="kw">model.2IA</span>(BrLabel)</span>
<span id="cb25-54"><a href="ch3.html#cb25-54"></a><span class="kw">summary</span>(model)</span></code></pre></div>
</div>
<div id="模型训练" class="section level2">
<h2><span class="header-section-number">2.6</span> 模型训练</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="ch3.html#cb26-1"></a>early_stop &lt;-<span class="st"> </span><span class="kw">callback_early_stopping</span>(<span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">patience =</span><span class="dv">10</span>)</span>
<span id="cb26-2"><a href="ch3.html#cb26-2"></a>print_dot_callback &lt;-<span class="st"> </span><span class="kw">callback_lambda</span>(</span>
<span id="cb26-3"><a href="ch3.html#cb26-3"></a>  <span class="dt">on_epoch_end =</span> <span class="cf">function</span>(epoch, logs) {</span>
<span id="cb26-4"><a href="ch3.html#cb26-4"></a>    <span class="cf">if</span> (epoch <span class="op">%%</span><span class="st"> </span><span class="dv">50</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb26-5"><a href="ch3.html#cb26-5"></a>    <span class="kw">cat</span>(<span class="st">&quot;.&quot;</span>)</span>
<span id="cb26-6"><a href="ch3.html#cb26-6"></a>  }</span>
<span id="cb26-7"><a href="ch3.html#cb26-7"></a>)  </span>
<span id="cb26-8"><a href="ch3.html#cb26-8"></a><span class="co"># may take a couple of minutes if epochs is more than 100</span></span>
<span id="cb26-9"><a href="ch3.html#cb26-9"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb26-10"><a href="ch3.html#cb26-10"></a>     fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(train.x, <span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>ClaimNb), </span>
<span id="cb26-11"><a href="ch3.html#cb26-11"></a>                          <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">batch_size=</span><span class="dv">10000</span>, <span class="dt">verbose=</span><span class="dv">1</span>,</span>
<span id="cb26-12"><a href="ch3.html#cb26-12"></a>                                       <span class="dt">validation_data=</span><span class="kw">list</span>(valid.x,dat2_valid<span class="op">$</span>ClaimNb),</span>
<span id="cb26-13"><a href="ch3.html#cb26-13"></a>                          <span class="dt">callback=</span><span class="kw">list</span>(early_stop,print_dot_callback))</span>
<span id="cb26-14"><a href="ch3.html#cb26-14"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb26-15"><a href="ch3.html#cb26-15"></a></span>
<span id="cb26-16"><a href="ch3.html#cb26-16"></a><span class="kw">matplot</span>(<span class="kw">cbind</span>(fit<span class="op">$</span>metrics<span class="op">$</span>loss,fit<span class="op">$</span>metrics<span class="op">$</span>val_loss), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>)</span>
<span id="cb26-17"><a href="ch3.html#cb26-17"></a>fit<span class="op">$</span>metrics</span>
<span id="cb26-18"><a href="ch3.html#cb26-18"></a></span>
<span id="cb26-19"><a href="ch3.html#cb26-19"></a>dat2_test<span class="op">$</span>fitGAMPlus &lt;-<span class="st"> </span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(test.x))</span>
<span id="cb26-20"><a href="ch3.html#cb26-20"></a><span class="kw">Poisson.Deviance</span>(dat2_test<span class="op">$</span>fitGAMPlus, dat2_test<span class="op">$</span>ClaimNb)</span>
<span id="cb26-21"><a href="ch3.html#cb26-21"></a><span class="kw">keras_poisson_dev</span>(dat2_test<span class="op">$</span>fitGAMPlus, dat2_test<span class="op">$</span>ClaimNb)</span></code></pre></div>
</div>
<div id="总结" class="section level2">
<h2><span class="header-section-number">2.7</span> 总结</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="ch3.html#cb27-1"></a>dev_sum&lt;-<span class="kw">fread</span>(<span class="st">&quot;./plots/1/dev_sum.csv&quot;</span>)[,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb27-2"><a href="ch3.html#cb27-2"></a>AD&lt;-<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="st">&quot;Neural network&quot;</span>,<span class="dt">test_error=</span><span class="dv">0</span>,<span class="dt">test_error_keras=</span><span class="dv">0</span>)</span>
<span id="cb27-3"><a href="ch3.html#cb27-3"></a>dev_sum&lt;-<span class="kw">rbind</span>(dev_sum,AD)</span>
<span id="cb27-4"><a href="ch3.html#cb27-4"></a>dev_sum<span class="op">$</span>test_error[<span class="dv">8</span>]&lt;-<span class="kw">round</span>(<span class="kw">Poisson.Deviance</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb),<span class="dv">4</span>)</span>
<span id="cb27-5"><a href="ch3.html#cb27-5"></a>dev_sum<span class="op">$</span>test_error_keras[<span class="dv">8</span>]&lt;-<span class="kw">round</span>(<span class="kw">keras_poisson_dev</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb),<span class="dv">4</span>)</span>
<span id="cb27-6"><a href="ch3.html#cb27-6"></a><span class="co"># write.csv(dev_sum,&quot;./plots/1/dev_sum.csv&quot;)</span></span></code></pre></div>
<pre><code>##                       model test_error test_error_keras
## 1                 Intercept    33.5695          21.7647
## 2                       GLM    31.7731          20.8665
## 3                 GLM Lasso    31.8132          20.8866
## 4                       GAM    31.6651          20.8125
## 5             Decision tree    30.9780          20.4690
## 6             Random forest    30.9652          20.4626
## 7 Generalized boosted model    30.8972          20.4286
## 8            Neural network    31.0607          20.5080</code></pre>
<ul>
<li>Boosting &gt; RF &gt; Tree &gt; NN &gt; GAM &gt; GLM &gt; Homo</li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch2.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": "github"
},
"fontsettings": {
"theme": "sepia",
"family": "serif",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
